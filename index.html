<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <meta charset="utf-8" />
        <title>Demo!</title>
        <link rel="icon" type="image/x-icon" href="./01_Logo_HSE_full_rus_CMYK.svg">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
        <link
        href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css"
        rel="stylesheet"
        />
        <link rel="stylesheet" href="style_1.css" type="text/css">
    </head>
    <body>

        <div class="navbar"> <!-- Верхняя панель меню -->
            <div class="dropdown">
                <button class="dropbtn">Поступление 
                <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'abitur', activeLayer)">Абитуриенты</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'stud', activeLayer)">Зачисленные</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'ratio', activeLayer)">Процентное соотношение</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="dropbtn">Демография и уровень жизни
                <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'population', activeLayer)">Численность населения</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'income', activeLayer)">Ср. доход населения</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'social', activeLayer)">Социальный лифт</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="dropbtn">Центр взаимодействия с регионами 
                <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'school', activeLayer)">Партнерские организации УОО</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'agree', activeLayer)">Соглашения</a>
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'events', activeLayer)">Выезды</a>
                </div>
            </div> 
            <div class="dropdown">
                <button class="dropbtn">Другое 
                <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-content">
                <a href="#" class="tablinks" onclick="showHideLayer(event, 'federal', activeLayer)">Фед. университет</a>
                </div>
            </div> 
        </div>

        <script>
            const color2023 = 'rgba(0, 0, 255, 1)';
            const color2022 = 'rgba(255, 0, 0, 1)';

            const listLayers = ['abitur', 'stud', 'income'];
            let activeLayer = 'abitur';

        </script>

        <div id="abitur" class="tabcontent"> 
            <div id="map" class ="view"></div>
            <div class="map-overlay" id="features">
                <p><b>Выезды Центра взаимодействия с регионами</b><br>Нажмите для отображения</p>
                <nav id='menu-abi' class="menu"></nav><hr width="94%"/>
                <div id="hd"><h2>Абитуриенты НИУ ВШЭ Москва в 2022 году</h2></div>
                <div id="pd"><p>Наведите курсор на регион</p></div>
            </div>
            <!-- <div class="leg-overlay">
                <div>
                <table >
                    <tr><td colspan="4"><div class="leg-abitur"></div></td></tr>
                    <tr><td>1</td><td><div class="text-in">200</div></td><td><div class="text-in">500</div></td><td><div class="text-in">7492</div></td></tr>
                  </table>
            </div>
        </div> -->
            
            <script>  
            // define access token
            mapboxgl.accessToken = 'pk.eyJ1IjoiYm9yaWtzdSIsImEiOiJjbGRlanFjaWcwZTZxM25vNnFrbHBjbzk4In0.QO9lS1QlWM51h2a8CLBU-Q';
            
            // create map
            const map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/boriksu/cldkcs08c001t01o4swsjsk67', // map style URL from Mapbox Studio - test1  
                zoom: 3.79,
                center: [57.568, 58.379],  
            });
            
            map.on('load', () => {
                // make a pointer cursor
                map.getCanvas().style.cursor = 'default';

                // change info window on hover
                map.on('mousemove', (event) => {
                    const states = map.queryRenderedFeatures(event.point, {
                        layers: [activeLayer]
                    });
                    const states_ukr = map.queryRenderedFeatures(event.point, {
                            layers: ['additional-reg-ukraine']
                        });

                    if (states_ukr.length) {
                        document.getElementById('pd').innerHTML = `<h3>${states_ukr[0].properties.name_ru}</h3><p><em>Территории, принятые в состав Российской Федерации 30.09.2022г.</em></p>`
                    }
                    else if (states.length) {
                        document.getElementById('pd').innerHTML = showData(activeLayer, states);
                    }
                    else {
                        document.getElementById('pd').innerHTML = `<p>Наведите курсор на регион</p>`; 
                    }
                });
            });


            // function showLayer(event, newlayer) {
            //     map.moveLayer(newlayer);
            //     activeLayer = newlayer;
            // }

            function showRightHeader(layer) {
                switch (layer) {
                    case 'abitur':
                        return 'Абитуриенты НИУ ВШЭ Москва в 2022 году'
                    case 'stud':
                        return 'Зачисленные студенты НИУ ВШЭ Москва в 2022 году'
                    case 'income':
                        return 'Процент абитуриентов НИУ ВШЭ Москва от населения региона </br>в возрасте 15-19 лет на 2022 год'
                    case 'ratio':
                        return 'Среднедушевые денежные доходы населения<br>по субъектам Российской федерации за 2021 год'
                    case 'population':
                        return 'Численность населения на 1 января 2022 года'
                    case 'social':
                        return 'Зачисленные по льготе "Социальный лифт" в 2022 году'
                    case 'school':
                    return 'Соглашения НИУ ВШЭ со школами на 01.02.2023г.'
                    case 'agree':
                        return 'Соглашение о взаимодействии с органом управления региона на 01.02.2023г.'
                    case 'events':
                        return 'Выезды и мероприятия Центра по взаимодействию с регионами'
                    case 'federal':
                        return 'Наличие федерального университета в регионе'
                }
            }

            function showHideLayer(event, newLayer, hideActiveLayer) {
                document.getElementById('hd').innerHTML = `<h2>${showRightHeader(newLayer)}</h2>`;
                if (newLayer == hideActiveLayer) {
                    return ; }
                map.setLayoutProperty(newLayer, 'visibility', 'visible');
                map.setLayoutProperty(hideActiveLayer, 'visibility', 'none');
                activeLayer = newLayer;
            }

            function showData(layer, states) {
                let dataNumber;
                switch (layer) {
                    case 'abitur':
                        return `<h3>${states[0].properties.name_ru}</h3><p><em>Количество абитуриентов: <strong>${states[0].properties.abitur}</strong></em></p>`;
                    case 'stud':
                        return `<h3>${states[0].properties.name_ru}</h3><p><em>Количество зачисленных: <strong>${states[0].properties.stud}</strong></em></p>`;
                    case 'income':
                        dataNumber = new Intl.NumberFormat("ru").format(states[0].properties.income);
                        return `<h3>${states[0].properties.name_ru}</h3><p><em><strong>${dataNumber}</strong> руб./месяц</em></p>`;
                    case 'ratio':
                        dataNumber = new Intl.NumberFormat("en", {style: "percent", minimumFractionDigits: 4}).format((states[0].properties.ratio_abitur)/10000);
                        return `<h3>${states[0].properties.name_ru}</h3><p><em>Показатель : <strong>${dataNumber}</strong></em></p>`;
                    case 'population':
                        const dataNumberAll = new Intl.NumberFormat("ru").format(states[0].properties.population);
                        dataNumber = new Intl.NumberFormat("ru").format(states[0].properties.teen);
                        return `<h3>${states[0].properties.name_ru}</h3><p><em><strong>${dataNumberAll}</strong> человек, из них <strong>${dataNumber}</strong> в возрасте 15-19 лет</em></p>`;
                    case 'social':
                        if (states[0].properties.social_lift_total == 0) {
                            return `<h3>${states[0].properties.name_ru}</h3><p><em>Из данного региона нет зачисленных по льготе "Социальный лифт"</em></p>`
                        } else {
                            return `<h3>${states[0].properties.name_ru}</h3><p>Количество зачисленных по льготе "Социальный лифт" : <strong>${states[0].properties.social_lift_total}</strong> , в том числе<br>
                                    <em>в рамках основного конкурса : <strong>${states[0].properties.social_lift}</strong></em><br>
                                    <em>в рамках конкурса на категорию "Дети ветеранов боевых действий" : <strong>${states[0].properties.social_lift_veteran}</strong></em></p>`
                        }
                    case 'school':
                        return `<h3>${states[0].properties.name_ru}</h3><p><em>Базовые школы: <strong>${states[0].properties.base_school}</strong></em></br>
                                <em>Школы-партнеры: <strong>${states[0].properties.school_partner}</strong></em></br>
                                <em> Школы распределенного лицея: <strong>${states[0].properties.licey}</strong></em></p>`;
                    case 'agree':
                        if (states[0].properties.agreement_1 == 0) {
                            return `<h3>${states[0].properties.name_ru}</h3><p><em>Соглашение не установлено</em></p>`
                        } else {
                            return `<h3>${states[0].properties.name_ru}</h3><p><em>Соглашение с: <strong>${states[0].properties.agreement}</strong></em></p>`
                        }
                    case 'events':
                        let text = "";
                        if (states[0].properties.event2022_1 == '1') {
                            let lines = states[0].properties.event2022.split('?');
                            for (let i = 0; i < lines.length; i++) {
                                let words = lines[i].split(';');
                                text += words[0] + ", " + words[1] + ", " + words[2] + "<br>"
                            }
                        }
                        if (states[0].properties.event2023_1 == '1') {
                            let lines = states[0].properties.event2023.split('?');
                            for (let i = 0; i < lines.length; i++) {
                                let words = lines[i].split(';');
                                text += words[0] + ", " + words[1] + ", " + words[2] + "<br>"
                            }
                        }
                        if (text == "") {
                            text += "<p><em>Мероприятия не проводились</em></p>"
                        }
                        return `<h3>${states[0].properties.name_ru}</h3><p>${text}</p>`
                    case 'federal':
                        if (states[0].properties.federal == "") {
                            return `<h3>${states[0].properties.name_ru}</h3><p><em>В регионе нет федерального университета</em></p>`
                        } else {
                            return `<h3>${states[0].properties.name_ru}</h3><p><em>${states[0].properties.federal}</em></p>`
                        }
                }
            }

            </script>

        </div>

    </body>
</html>
